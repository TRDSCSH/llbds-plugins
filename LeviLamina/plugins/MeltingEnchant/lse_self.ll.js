// LiteLoader-AIDS automatic generated
/// <reference path="f:\BDS\BDSLLSE2.0/dts/helperlib/src/index.d.ts"/> 

ll.registerPlugin(
    /* name */ "MeltingEnchant",
    /* introduction */ "熔炉提升附魔",
    /* version */ [6,6,6],
    /* otherInformation */ null
); 

const _0x3078=['w4d4Zg==','KCPClsO6KlrCnsKmOcO4RsOlwoDDnlY=','w6wOw5TDlcOQJ8O0','woh3w5Q=','wpIvbcK+wpxQwqY=','dsOowqnDtcKAd2nChB3DkT8vFMO8V8O1wqIlw5k3wo7CvxfCtsKAworDhMKkHsOYRsOm','wp7DmMK0wqHDuELCvg==','wp7CkD8TAQ==','w5PCkcOFFj4vHw==','w4Uswpp1Kg==','O8K3CsOpwpnDusOFfg==','w6JtSFImESk=','YwfCr8OmDMO8woUdJcKEKQ==','WMO3w48Fw4g=','FMOKw7wHPk/CmcKWHnDCrhkiWg==','w6oTw4jDicON','K8OrwoA=','AWsXck3Cow==','wqMnw43DjcKXfh/DtzAFw79ENMKIwoQ5w7vCoiw=','GcKkw4AE','5pev5rK05Ymm6L+aw4jCvOach+WKrOWau+eLneaej+i+oeS9lQ==','6a+k5rCr552Y','w6kBdQ==','wrNew5Q5wqI=','wonDhcK7wrHDsg==','d8KAw7IWP0DCiMK6H2HCmQgtTWzDocK1ZStaJsKmw7BIwpHDvcK9wr/DmiDDtSDCgHrCs8OnUxTCkcOBB8KFBh7Cv8KFKRjCjcO9Hl8qA8OIwojChw==','ECZfe1hIHw==','McOlcsKnwrg=','wo3CkHo=','wp3DnMOFRlXCpw==','RcOrw4gJ','WMOkw50Nw4Z6w6cnw41qfzAgV8KsF8OVYlPDpsKpw7PCscOsw4/DucKgd8OKUMKXCsOiT2A8wp/CgMOrw7zCnw==','TnzDnyA=','MRQGMMK7','P8OnwpYF','wqZLw5ch','54S354KI5o6P5Y+J6Zu26ay3wrYqw6HkvIrogJNmwpjDhsOkWcKRecKZKcKKw7TCnW8=','w4zDoXnCg8OfNy3Dnw=='];(function(_0x29216d,_0x3078ef){const _0x2f17c4=function(_0x2a86a3){while(--_0x2a86a3){_0x29216d['push'](_0x29216d['shift']());}};const _0x37d4ee=function(){const _0x522e35={'data':{'key':'cookie','value':'timeout'},'setCookie':function(_0x4585ae,_0x265515,_0x5a7475,_0xafcefc){_0xafcefc=_0xafcefc||{};let _0x3f459e=_0x265515+'='+_0x5a7475;let _0x4b5dd3=0x0;for(let _0x591f70=0x0,_0x4b3be1=_0x4585ae['length'];_0x591f70<_0x4b3be1;_0x591f70++){const _0x164ae6=_0x4585ae[_0x591f70];_0x3f459e+=';\x20'+_0x164ae6;const _0x5b84f3=_0x4585ae[_0x164ae6];_0x4585ae['push'](_0x5b84f3);_0x4b3be1=_0x4585ae['length'];if(_0x5b84f3!==!![]){_0x3f459e+='='+_0x5b84f3;}}_0xafcefc['cookie']=_0x3f459e;},'removeCookie':function(){return'dev';},'getCookie':function(_0x2bc548,_0xbf2fcd){_0x2bc548=_0x2bc548||function(_0x45924c){return _0x45924c;};const _0x131397=_0x2bc548(new RegExp('(?:^|;\x20)'+_0xbf2fcd['replace'](/([.$?*|{}()[]\/+^])/g,'$1')+'=([^;]*)'));const _0x267ca0=function(_0x2a7f0c,_0x532359){_0x2a7f0c(++_0x532359);};_0x267ca0(_0x2f17c4,_0x3078ef);return _0x131397?decodeURIComponent(_0x131397[0x1]):undefined;}};const _0x2f29e1=function(){const _0x293866=new RegExp('\x5cw+\x20*\x5c(\x5c)\x20*{\x5cw+\x20*[\x27|\x22].+[\x27|\x22];?\x20*}');return _0x293866['test'](_0x522e35['removeCookie']['toString']());};_0x522e35['updateCookie']=_0x2f29e1;let _0x5a8433='';const _0x1a9651=_0x522e35['updateCookie']();if(!_0x1a9651){_0x522e35['setCookie'](['*'],'counter',0x1);}else if(_0x1a9651){_0x5a8433=_0x522e35['getCookie'](null,'counter');}else{_0x522e35['removeCookie']();}};_0x37d4ee();}(_0x3078,0x110));const _0x2f17=function(_0x29216d,_0x3078ef){_0x29216d=_0x29216d-0x0;let _0x2f17c4=_0x3078[_0x29216d];if(_0x2f17['HaitNE']===undefined){(function(){let _0x522e35;try{const _0x5a8433=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x522e35=_0x5a8433();}catch(_0x1a9651){_0x522e35=window;}const _0x2f29e1='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';_0x522e35['atob']||(_0x522e35['atob']=function(_0x4585ae){const _0x265515=String(_0x4585ae)['replace'](/=+$/,'');let _0x5a7475='';for(let _0xafcefc=0x0,_0x3f459e,_0x4b5dd3,_0x591f70=0x0;_0x4b5dd3=_0x265515['charAt'](_0x591f70++);~_0x4b5dd3&&(_0x3f459e=_0xafcefc%0x4?_0x3f459e*0x40+_0x4b5dd3:_0x4b5dd3,_0xafcefc++%0x4)?_0x5a7475+=String['fromCharCode'](0xff&_0x3f459e>>(-0x2*_0xafcefc&0x6)):0x0){_0x4b5dd3=_0x2f29e1['indexOf'](_0x4b5dd3);}return _0x5a7475;});}());const _0x2a86a3=function(_0x4b3be1,_0x164ae6){let _0x5b84f3=[],_0x2bc548=0x0,_0xbf2fcd,_0x131397='',_0x267ca0='';_0x4b3be1=atob(_0x4b3be1);for(let _0x2a7f0c=0x0,_0x532359=_0x4b3be1['length'];_0x2a7f0c<_0x532359;_0x2a7f0c++){_0x267ca0+='%'+('00'+_0x4b3be1['charCodeAt'](_0x2a7f0c)['toString'](0x10))['slice'](-0x2);}_0x4b3be1=decodeURIComponent(_0x267ca0);let _0x45924c;for(_0x45924c=0x0;_0x45924c<0x100;_0x45924c++){_0x5b84f3[_0x45924c]=_0x45924c;}for(_0x45924c=0x0;_0x45924c<0x100;_0x45924c++){_0x2bc548=(_0x2bc548+_0x5b84f3[_0x45924c]+_0x164ae6['charCodeAt'](_0x45924c%_0x164ae6['length']))%0x100;_0xbf2fcd=_0x5b84f3[_0x45924c];_0x5b84f3[_0x45924c]=_0x5b84f3[_0x2bc548];_0x5b84f3[_0x2bc548]=_0xbf2fcd;}_0x45924c=0x0;_0x2bc548=0x0;for(let _0x293866=0x0;_0x293866<_0x4b3be1['length'];_0x293866++){_0x45924c=(_0x45924c+0x1)%0x100;_0x2bc548=(_0x2bc548+_0x5b84f3[_0x45924c])%0x100;_0xbf2fcd=_0x5b84f3[_0x45924c];_0x5b84f3[_0x45924c]=_0x5b84f3[_0x2bc548];_0x5b84f3[_0x2bc548]=_0xbf2fcd;_0x131397+=String['fromCharCode'](_0x4b3be1['charCodeAt'](_0x293866)^_0x5b84f3[(_0x5b84f3[_0x45924c]+_0x5b84f3[_0x2bc548])%0x100]);}return _0x131397;};_0x2f17['IBDmSb']=_0x2a86a3;_0x2f17['MvTFHr']={};_0x2f17['HaitNE']=!![];}const _0x37d4ee=_0x2f17['MvTFHr'][_0x29216d];if(_0x37d4ee===undefined){if(_0x2f17['TmTEji']===undefined){const _0x445d57=function(_0xc2705b){this['ywPeUO']=_0xc2705b;this['jLHllL']=[0x1,0x0,0x0];this['NhrgkS']=function(){return'newState';};this['UOoiLr']='\x5cw+\x20*\x5c(\x5c)\x20*{\x5cw+\x20*';this['YJdQvv']='[\x27|\x22].+[\x27|\x22];?\x20*}';};_0x445d57['prototype']['HvhQbt']=function(){const _0x24317a=new RegExp(this['UOoiLr']+this['YJdQvv']);const _0x23e330=_0x24317a['test'](this['NhrgkS']['toString']())?--this['jLHllL'][0x1]:--this['jLHllL'][0x0];return this['vZNSbW'](_0x23e330);};_0x445d57['prototype']['vZNSbW']=function(_0x4fa4e1){if(!Boolean(~_0x4fa4e1)){return _0x4fa4e1;}return this['vkpWoe'](this['ywPeUO']);};_0x445d57['prototype']['vkpWoe']=function(_0x5b8df8){for(let _0x4dff2e=0x0,_0x716a0f=this['jLHllL']['length'];_0x4dff2e<_0x716a0f;_0x4dff2e++){this['jLHllL']['push'](Math['round'](Math['random']()));_0x716a0f=this['jLHllL']['length'];}return _0x5b8df8(this['jLHllL'][0x0]);};new _0x445d57(_0x2f17)['HvhQbt']();_0x2f17['TmTEji']=!![];}_0x2f17c4=_0x2f17['IBDmSb'](_0x2f17c4,_0x3078ef);_0x2f17['MvTFHr'][_0x29216d]=_0x2f17c4;}else{_0x2f17c4=_0x37d4ee;}return _0x2f17c4;};const _0x4585ae=function(){let _0x372529=!![];return function(_0x54aad8,_0x26ef5d){const _0x5443b0=_0x372529?function(){if(_0x26ef5d){const _0x3faf99=_0x26ef5d[_0x2f17('0x11','@1YW')](_0x54aad8,arguments);_0x26ef5d=null;return _0x3faf99;}}:function(){};_0x372529=![];return _0x5443b0;};}();const _0x1a9651=_0x4585ae(this,function(){const _0x477cd1=function(){const _0x1286c7=_0x477cd1[_0x2f17('0x6','kmVa')]('return\x20/\x22\x20+\x20this\x20+\x20\x22/')()['compile']('^([^\x20]+(\x20+[^\x20]+)+)+[^\x20]}');return!_0x1286c7[_0x2f17('0x1d','@1YW')](_0x1a9651);};return _0x477cd1();});_0x1a9651();const _0x522e35=function(){let _0x1d16c7=!![];return function(_0x428f42,_0x386004){const _0x3356ba=_0x1d16c7?function(){if(_0x386004){const _0x5baf06=_0x386004[_0x2f17('0x3','h#or')](_0x428f42,arguments);_0x386004=null;return _0x5baf06;}}:function(){};_0x1d16c7=![];return _0x3356ba;};}();const _0x2a86a3=_0x522e35(this,function(){const _0x22ea0c=function(){};let _0x588ef9;try{const _0x5413f1=Function(_0x2f17('0xc','(RQ9')+_0x2f17('0x25','DCOV')+');');_0x588ef9=_0x5413f1();}catch(_0x24c77f){_0x588ef9=window;}if(!_0x588ef9['console']){_0x588ef9[_0x2f17('0x14','MD3u')]=function(_0x2647fe){const _0x4e30a4={};_0x4e30a4[_0x2f17('0x23','o8)L')]=_0x2647fe;_0x4e30a4[_0x2f17('0x1c','e[YY')]=_0x2647fe;_0x4e30a4['debug']=_0x2647fe;_0x4e30a4['info']=_0x2647fe;_0x4e30a4[_0x2f17('0x1','!C]$')]=_0x2647fe;_0x4e30a4['exception']=_0x2647fe;_0x4e30a4[_0x2f17('0x1b','nCgf')]=_0x2647fe;_0x4e30a4[_0x2f17('0x12','%bPJ')]=_0x2647fe;return _0x4e30a4;}(_0x22ea0c);}else{_0x588ef9[_0x2f17('0x2','BTlK')][_0x2f17('0x10','&E3b')]=_0x22ea0c;_0x588ef9['console'][_0x2f17('0xd','hJ2!')]=_0x22ea0c;_0x588ef9['console']['debug']=_0x22ea0c;_0x588ef9[_0x2f17('0x22','AKRV')][_0x2f17('0x18','dNE@')]=_0x22ea0c;_0x588ef9['console'][_0x2f17('0x9','AKRV')]=_0x22ea0c;_0x588ef9[_0x2f17('0x5','(^Pd')]['exception']=_0x22ea0c;_0x588ef9['console'][_0x2f17('0x15','uOi5')]=_0x22ea0c;_0x588ef9[_0x2f17('0x0','%bPJ')][_0x2f17('0x7','dNE@')]=_0x22ea0c;}});_0x2a86a3();const BDSVersion=mc['getBDSVersion']()['split']('.',0x3);if(BDSVersion[0x1]<0x14||BDSVersion[0x1]==0x14&&BDSVersion[0x2]<0x1e){colorLog(_0x2f17('0x16','jxGX'),_0x2f17('0xe','rTuZ'));for(let i=0x0;;i++){system[_0x2f17('0xa','e[YY')](_0x2f17('0x19','dNE@'),()=>{});}}const PluginName=_0x2f17('0x8','KTI8'),items=_0x2f17('0x13','KTI8'),it=new JsonConfigFile(items,JSON['stringify']({'format_version':_0x2f17('0x24','j]LJ'),'minecraft:item':{'description':{'identifier':'item:enchant_stone','category':_0x2f17('0x1f','s%40')},'components':{'minecraft:enchantable':{'slot':_0x2f17('0x20','#ocW'),'value':0x1e},'minecraft:display_name':{'value':_0x2f17('0xf','BTlK')},'minecraft:icon':{'texture':_0x2f17('0x4','P31Q')},'minecraft:fuel':{'duration':0xa0}}}}));mc[_0x2f17('0xb','yxdv')](_0x2f17('0x21',']bXT'),function(){File[_0x2f17('0x17','w0dz')](items);colorLog(_0x2f17('0x1a','4Qy1'),_0x2f17('0x1e','j]LJ'));});

const wenj = new JsonConfigFile('./plugins/MeltingEnchant/Melting_Enchant/Melting_Enchant.json', JSON.stringify({
    "blocks": [
        "minecraft:blast_furnace",
        "minecraft:lit_blast_furnace",
        "minecraft:smoker",
        "minecraft:lit_smoker",
        "minecraft:furnace",
        "minecraft:lit_furnace"
    ],
    "掉落率": 0.15,
    "熔炼成功率": 0.95
}));
wenj.init("显示文本", ['§r§h 附魔已提升', '§r§h? 可在熔炉为附魔提升等级']);
wenj.init('掉落附魔ID', [0,1,2,3,4,5,6,9,10,11,12,13,14,15,17,18,19,20,21,23,24,29,30,31,34,35,36,37]);

const plugin_block = wenj.get('blocks'),
    plugin_dl = wenj.get('掉落率'),
    plugin_lz = wenj.get('熔炼成功率'),
    text = wenj.get('显示文本'),
    enchID = wenj.get('掉落附魔ID');


function randomNum(value, lvl, zl) {
    //这个函数返回概率计算结果
    var value = parseFloat(Number(value)), lvl = parseFloat(Number(lvl*2)*0.01), add = parseFloat(Number(zl)*0.05);
    !lvl ? null : value = value - lvl;
    //下降几率
    !zl ? null : value = value + add;
    //提升几率
    // log(lvl, ' ', add, ' ', value);
    value < 0.02 ? value = 0.02 : null;
    //最低2%
    let c = value.toString().split('.', 10),
            //将value转字符串转数组
        t = 'total', 
            //记个单词 读作 : '泰罗' : 总, 全, 共
        x;
    if(c.length == 1) {
        //简单判断数组个数;
        return c[0] > 0 ? true : false ;
            //如果是整数, 大于0就直接成功否则失败;
    }
        t = Math.pow(10, c[1].length);
            //总数 所有数
        c = value * Math.pow(10, c[1].length);
            //判断基准数 小于就是true
    function a(value, c, t, x) {
        x = Math.floor(Math.random() * t);
        return x < c ? true : false
    }

    function b(value, c, t, x) {
        //测试模式
        let a = [0, 0, 0];
        for(let i = 0; i < 10000; i++) {
            x = Math.floor(Math.random() * t);
            x < c ? a[1]++ : a [0]++ ;
        }
            value = a[0] + a[1] + a[2];
        return '抽奖次数: ' + value + '中奖次数: ' + a[1] + '§c 未中率: ' + ((a[0] / value) * 100).toFixed(2) + "%§d 中奖率" + ((a[1] / value) * 100).toFixed(2) + '%'
    }
    return a(value, c, t, x)
}

function texts(object) {
    //这个函数返回对象的字符串 
    return object.toString()
}

function objectNBT(NBTobject, type) {
    //这个函数返回NBT对象的NBT, 提供类型参数时返回SNBT
    return !NBTobject ? null : !type ? NBTobject.getNbt() : NBTobject.getNbt().toSNBT(type)
}

function containerNBT(object) {
    //这个函数返回对象容器物品数组
    if(object.hasContainer() == false) {
        return null
    }else{
        var object = object.getContainer(),
            Container = object.getAllItems();
        return Container
    }
}

function itemEnch(it, it_, type) {
    //这个函数判断第二个物品是否含有第一个物品的附魔
    let itNBT = it.getNbt(),
        it_NBT = it_.getNbt(),
        itEnch = itNBT.getTag('tag').getTag('ench'),
        it_Ench = it_NBT.getTag('tag').getTag('ench');
    let newitem = it.clone(),
        newitemNBT = objectNBT(newitem),
        Array_a = []; 
    for(let i = 0; i < itEnch.getSize(); i++) {
        for(let a = 0; a < it_Ench.getSize(); a++){
            if (itEnch.getData(i).getData('id') == it_Ench.getData(a).getData('id') && itEnch.getData(i).getData('lvl') <= it_Ench.getData(a).getData('lvl')) {
                Array_a.push(itEnch.getData(i).getData('lvl'));
                if(!type){
                    let Ench_i = newitemNBT.getTag('tag').getTag('ench').getTag(i);
                    if(itEnch.getData(i).getData('lvl') == it_Ench.getData(a).getData('lvl')){
                        Ench_i.setShort('lvl', Ench_i.getData('lvl') + 1);
                        newitem.setNbt(newitemNBT);
                        break;
                    }else {
                        Ench_i.setShort('lvl', it_Ench.getData(a).getData('lvl'));
                        newitem.setNbt(newitemNBT);
                        break;
                    }
                }else if (type==1){
                    return true
                }
            }
        }
    }
    if (type == 2) return Math.max(Array_a);
    return newitem
}

mc.listen('onContainerChange', function(pl, bl, slotNum, oit, nit) {
    mc.newScoreObjective(PluginName+'S');
    setTimeout(f, 10);
    function f() {
        if(!bl || !plugin_block.includes(bl.type, 4) || !bl.hasContainer()) return
        if(plugin_block.includes(bl.type, 4) == true) {
            let containerItem = containerNBT(mc.getBlock(bl.pos));
            if (containerItem[2].count > 0) return
            if (containerItem[1].isEnchanted == true && containerItem[1].type == 'item:enchant_stone' && containerItem[0].isEnchanted == true) {
                let it_0 = containerItem[0].clone(),
                    it_1 = containerItem[1].clone(),
                    containerBlock = bl.getContainer();
                if (itemEnch(it_0, it_1, 1) == true) {
                    if(randomNum(plugin_lz, itemEnch(it_0, it_1, 2), pl.getScore(PluginName+'S')) == true) {
                        containerBlock.setItem(2, itemEnch(it_0, it_1));
                        if(containerBlock.removeItem(2, it_0.count - 1) == true) {
                            containerBlock.removeItem(0, 1); containerBlock.removeItem(1, 1);
                            let it = containerNBT(mc.getBlock(bl.pos))[2];
                            if(it.lore[0] == null) {
                                it.setLore([it.lore, text[2]]);
                            }
                            mc.runcmdEx(`playsound random.levelup @a ${bl.pos.x} ${bl.pos.y} ${bl.pos.z}`);
                            mc.runcmdEx(`playsound firework.large_blast @a ${bl.pos.x} ${bl.pos.y} ${bl.pos.z}`);
                            mc.runcmdEx(`playsound camera.take_picture @a ${bl.pos.x} ${bl.pos.y} ${bl.pos.z}`);
                            pl.setScore(PluginName+'S', 0);
                            setTimeout(() => {
                                pl.refreshItems()
                            }, 0);
                        }
                    }else {
                        containerBlock.removeItem(0, 1); containerBlock.removeItem(1, 1);
                        pl.sendText('§c哎呀! 炸炉啦! 下次会更走运噢!');
                        mc.runcmdEx(`playsound random.break @a ${bl.pos.x} ${bl.pos.y} ${bl.pos.z}`)
                        mc.runcmdEx(`playsound ambient.weather.lightning.impact @a ${bl.pos.x} ${bl.pos.y} ${bl.pos.z}`)
                        setTimeout(() => {
                            mc.runcmdEx(`setblock ${bl.pos.x} ${bl.pos.y} ${bl.pos.z} air destroy`);
                            let a = pl.getScore(PluginName+'S');
                            a > 0 ? pl.addScore(PluginName+'S', a*2) : pl.addScore(PluginName+'S', 1);
                        }, 0);
                    }
                }
                it_0 = undefined;
                it_1 = undefined;
                containerBlock = undefined;
            }
            containerItem = undefined;
        }
    }
})

mc.listen('onInventoryChange', function(pl, slot, oldItem, newItem) {
    if(newItem.type == 'item:enchant_stone') {
        var lore = newItem.lore,
            text_a = text[1];
        if(newItem.isEnchanted == true) {
            if(newItem.lore.indexOf(text_a) == -1){
                lore.push(text_a);
                newItem.setLore(lore);
            }
        }else {
            if(newItem.lore.indexOf(text_a) !== -1){
                lore.splice(newItem.lore.indexOf(text_a), 1);
                newItem.setLore(lore);
            }
        }
        lore = undefined;
        text_a = undefined;
        setTimeout(() => {
            pl.refreshItems()
        }, 0);
    }
})

mc.listen('onDestroyBlock', function(pl, bl) {
    if(pl.gameMode != 1) {
        if(bl.type == 'minecraft:deepslate_lapis_ore' || bl.type == 'minecraft:lapis_ore') {
            let en_All = mc.getAllEntities();
            setTimeout(() => {
                let en_A = mc.getAllEntities();
                for (let i = en_A.length - 1; i > en_All.length - 1; i--) {
                    //difference 表示 两个数组个数之差; 这里使用前后两个数组来判断新实体数量
                    if(en_A[i].isItemEntity() == true && texts(en_A[i].blockPos) == texts(bl.pos)) {
                        if(randomNum(plugin_dl) == true) {
                            let it_enNBT = en_A[i].getNbt(),
                                _item = it_enNBT.getTag('Item'),
                                snbt = `{display:{Lore:["${text[1]}"]},ench:[{id:${enchID[Math.floor((Math.random() * enchID.length))]}s,lvl:${Math.ceil((Math.random() * 2))}s}]}`,
                                tagNBT = NBT.parseSNBT(snbt);
                            _item.setTag('tag', tagNBT);
                            _item.setString('Name', 'item:enchant_stone');
                            en_A[i].setNbt(it_enNBT);
                        }
                    }
                }
                    en_A = undefined;
                    en_All = undefined;
            }, 0);
        }
    }
})